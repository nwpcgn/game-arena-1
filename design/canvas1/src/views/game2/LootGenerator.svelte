<script lang="ts">
	type Rarity = 'common' | 'uncommon' | 'rare' | 'epic' | 'legendary'
	type Category = 'weapon' | 'armor' | 'potion' | 'material' | 'special'

	type LootItem = {
		name: string
		rarity: Rarity
		category: Category
		dropChance: number
	}

	const msg = {
		positive_event: [
			{
				type: 'positive_event',
				text: 'Du sp√ºrst eine warme Energie ‚Äì deine Wunden heilen sich!'
			},
			{
				type: 'positive_event',
				text: 'Ein Lichtstrahl trifft dich. Du f√ºhlst dich pl√∂tzlich st√§rker.'
			},
			{
				type: 'positive_event',
				text: 'Du findest einen geheimen Pfadder dir Zeit erspart.'
			},
			{
				type: 'positive_event',
				text: 'Ein freundlicher Geist √ºberreicht dir ein Geschenk.'
			},
			{
				type: 'positive_event',
				text: 'Ein alter Zauber wurde aufgel√∂st ‚Äì du f√ºhlst dich erleichtert.'
			},
			{
				type: 'positive_event',
				text: 'Die Sonne bricht durch die Wolken und f√ºllt dich mit Hoffnung.'
			},
			{
				type: 'positive_event',
				text: 'Du entdeckst eine Quelle reiner Magie ‚Äì deine Kraft ist erneuert.'
			},
			{
				type: 'positive_event',
				text: 'Ein Reisender segnet dich mit Gl√ºck auf deinem Weg.'
			},
			{
				type: 'positive_event',
				text: 'Ein altes Lied erklingt ‚Äì du f√ºhlst dich inspiriert.'
			},
			{
				type: 'positive_event',
				text: 'Ein Schutzkreis sch√ºtzt dich vor dem n√§chsten Schaden.'
			},
			{
				type: 'positive_event',
				text: 'Du wirst mit einer Vision der Zukunft erf√ºllt ‚Äì und f√ºhlst dich vorbereitet.'
			},
			{
				type: 'positive_event',
				text: 'Du erh√§ltst einen geheimen Segen ‚Äì deine n√§chste Begegnung wird einfacher.'
			},
			{
				type: 'positive_event',
				text: 'Ein Vogel bringt dir eine wertvolle Nachricht.'
			},
			{
				type: 'positive_event',
				text: 'Du findest einen alten Brief ‚Äì er st√§rkt deinen Mut.'
			},
			{
				type: 'positive_event',
				text: 'Deine Sinne sch√§rfen sich ‚Äì du erkennst eine Gefahr im Voraus.'
			}
		],
		negative_event: [
			{
				type: 'negative_event',
				text: 'Ein pl√∂tzlicher Schatten streift dich ‚Äì du verlierst Lebensenergie.'
			},
			{
				type: 'negative_event',
				text: 'Du trittst in eine Falle und verletzt dich.'
			},
			{
				type: 'negative_event',
				text: 'Ein magischer Sturm trifft dich mit voller Wucht.'
			},
			{
				type: 'negative_event',
				text: 'Deine Tasche ist besch√§digt ‚Äì einige Gegenst√§nde sind verloren.'
			},
			{
				type: 'negative_event',
				text: 'Eine dunkle Pr√§senz raubt dir deine Kraft.'
			},
			{
				type: 'negative_event',
				text: 'Du wirst von seltsamen Stimmen heimgesucht ‚Äì deine Moral sinkt.'
			},
			{
				type: 'negative_event',
				text: 'Dein Weg wird durch unheimliche Kreaturen blockiert.'
			},
			{
				type: 'negative_event',
				text: 'Ein Dieb stiehlt dir unbemerkt etwas aus deinem Inventar.'
			},
			{
				type: 'negative_event',
				text: 'Du verlierst die Orientierung in dichtem Nebel.'
			},
			{
				type: 'negative_event',
				text: 'Ein Bann l√§hmt dich vor√ºbergehend.'
			},
			{
				type: 'negative_event',
				text: 'Dein Feuerholz ist nass ‚Äì du kannst kein Lager machen.'
			},
			{
				type: 'negative_event',
				text: 'Ein b√∂sartiger Blick l√§hmt dich mit Angst.'
			},
			{
				type: 'negative_event',
				text: 'Du st√ºrzt in ein Erdloch und verletzt dich am Bein.'
			},
			{
				type: 'negative_event',
				text: 'Dein Amulett zerbricht ‚Äì ein Teil deiner Macht geht verloren.'
			},
			{
				type: 'negative_event',
				text: 'Ein alter Fluch aktiviert sich pl√∂tzlich.'
			}
		],
		loot_found: [
			{
				type: 'loot_found',
				text: 'Du √∂ffnest eine Truhe und findest: {item_name}!'
			},
			{
				type: 'loot_found',
				text: 'In einem Haufen Asche entdeckst du {item_name}.'
			},
			{
				type: 'loot_found',
				text: 'Ein Monster lie√ü etwas fallen ‚Äì {item_name} geh√∂rt jetzt dir.'
			},
			{
				type: 'loot_found',
				text: 'Versteckt unter einem Stein findest du {item_name}.'
			},
			{
				type: 'loot_found',
				text: 'Du erh√§ltst {item_name} als Belohnung f√ºr deinen Mut.'
			},
			{
				type: 'loot_found',
				text: 'Ein Lichtschein f√ºhrt dich zu {item_name}.'
			},
			{
				type: 'loot_found',
				text: 'Du gr√§bst im Sand und findest {item_name}.'
			},
			{
				type: 'loot_found',
				text: 'Du hast {item_name} durch Zufall entdeckt!'
			},
			{
				type: 'loot_found',
				text: 'Du gewinnst {item_name} im Spiel gegen einen H√§ndler.'
			},
			{
				type: 'loot_found',
				text: 'Ein geheimnisvoller Fremder √ºbergibt dir {item_name}.'
			},
			{
				type: 'loot_found',
				text: '{item_name} erscheint pl√∂tzlich in deiner Tasche.'
			},
			{
				type: 'loot_found',
				text: 'Ein R√§tsel wurde gel√∂st ‚Äì als Belohnung bekommst du {item_name}.'
			},
			{
				type: 'loot_found',
				text: 'Deine Geduld zahlt sich aus ‚Äì du findest {item_name}.'
			},
			{
				type: 'loot_found',
				text: 'Ein alter Baum wirft {item_name} ab.'
			},
			{
				type: 'loot_found',
				text: 'Du findest {item_name} in einer alten H√∂hle.'
			}
		],
		npc_dialogue: [
			{
				type: 'npc_dialogue',
				text: 'Sei vorsichtigFremder. Nicht alles ist so friedlich'
			},
			{
				type: 'npc_dialogue',
				text: 'Ich habe Geschichten geh√∂rt von einem Schatz tief im Osten.'
			},
			{
				type: 'npc_dialogue',
				text: 'Du erinnerst mich an jemanden... einen alten Helden vielleicht.'
			},
			{
				type: 'npc_dialogue',
				text: 'Meine Katze ist verschwunden. Wenn du sie findestbekommst du eine Belohnung.'
			},
			{
				type: 'npc_dialogue',
				text: 'Man sagtdie Sterne fl√ºstern mit jenen'
			},
			{
				type: 'npc_dialogue',
				text: 'Schau dich gut um. Manchmal versteckt sich das Wertvollste direkt vor deinen Augen.'
			},
			{
				type: 'npc_dialogue',
				text: 'Die Dunkelheit w√§chst. Pass auf dich auf da drau√üen.'
			},
			{
				type: 'npc_dialogue',
				text: 'Wenn du nach S√ºden gehstnimm gen√ºgend Tr√§nke mit.'
			},
			{
				type: 'npc_dialogue',
				text: 'Ich war einst Abenteurer wie du ‚Äì bis ich ein Schwert im Knie hatte.'
			},
			{
				type: 'npc_dialogue',
				text: 'Hast du etwas zu handeln? Ich suche besondere Materialien.'
			},
			{
				type: 'npc_dialogue',
				text: 'Hier war fr√ºher eine gro√üe Stadt... jetzt ist nur noch Stille.'
			},
			{
				type: 'npc_dialogue',
				text: 'Suchst du Arbeit? Ich habe da etwas f√ºr dich... wenn du mutig bist.'
			},
			{
				type: 'npc_dialogue',
				text: 'H√∂rst du das? Etwas stimmt nicht mit diesem Ort.'
			},
			{
				type: 'npc_dialogue',
				text: 'Der Fluss spricht. Hast du es bemerkt?'
			},
			{
				type: 'npc_dialogue',
				text: 'Einmal war ich auf der anderen Seite der Berge ‚Äì dort gibt es Wunder.'
			}
		],
		combat_start: [
			{
				type: 'combat_start',
				text: 'Ein Schatten bewegt sich ‚Äì bereite dich auf den Kampf vor!'
			},
			{
				type: 'combat_start',
				text: 'Dein Herz schl√§gt schneller ‚Äì ein Gegner n√§hert sich!'
			},
			{
				type: 'combat_start',
				text: 'Du hast den falschen Pfad gew√§hlt!ruft dein Feind.'
			},
			{
				type: 'combat_start',
				text: 'Dein Gegner zieht seine Waffe. Keine Gnade!'
			},
			{
				type: 'combat_start',
				text: 'Du sp√ºrst feindliche Pr√§senz ‚Äì der Kampf beginnt.'
			},
			{
				type: 'combat_start',
				text: 'Das wird dir noch leid tun!schreit dein Widersacher.'
			},
			{
				type: 'combat_start',
				text: 'Ein Ger√§usch hinter dir ‚Äì du wirst angegriffen!'
			},
			{
				type: 'combat_start',
				text: 'Endlich ein w√ºrdiger Gegner!ruft der Feind.'
			},
			{
				type: 'combat_start',
				text: 'Der Boden zittert ‚Äì etwas Gro√ües n√§hert sich.'
			},
			{
				type: 'combat_start',
				text: 'Dein Instinkt war richtig ‚Äì du bist nicht allein.'
			}
		],
		level_up: [
			{
				type: 'level_up',
				text: 'Du f√ºhlst dich st√§rker ‚Äì du bist aufgestiegen!'
			},
			{
				type: 'level_up',
				text: 'Ein neues Level! Neue Kr√§fte erwachen in dir.'
			},
			{
				type: 'level_up',
				text: 'Dein Training zahlt sich aus ‚Äì du bist gewachsen.'
			},
			{
				type: 'level_up',
				text: 'Du meisterst eine neue F√§higkeit.'
			},
			{
				type: 'level_up',
				text: 'Ein Licht durchdringt dich ‚Äì du hast ein Level erreicht.'
			},
			{
				type: 'level_up',
				text: 'Dein K√∂rper pulsiert vor Energie ‚Äì Level Up!'
			},
			{
				type: 'level_up',
				text: 'Erfahrung macht dich weiser ‚Äì du bist bereit f√ºr mehr.'
			},
			{
				type: 'level_up',
				text: 'Die Luft um dich vibriert ‚Äì du entwickelst dich weiter.'
			},
			{
				type: 'level_up',
				text: 'Du bist nun m√§chtiger als je zuvor.'
			},
			{
				type: 'level_up',
				text: 'Gut gemacht!h√∂rst du eine Stimme in deinem Inneren.'
			}
		],
		tutorial: [
			{
				type: 'tutorial',
				text: 'Dr√ºcke [E]um mit Objekten zu interagieren.'
			},
			{
				type: 'tutorial',
				text: '√ñffne dein Inventar mit [I]um Gegenst√§nde zu verwenden.'
			},
			{
				type: 'tutorial',
				text: 'Speichere regelm√§√üig ‚Äì du wei√üt niewas kommt.'
			},
			{
				type: 'tutorial',
				text: 'Tr√§nke kannst du in deinem Inventar anwenden.'
			},
			{
				type: 'tutorial',
				text: 'K√§mpfe mit [Linksklick] und blocke mit [Rechtsklick].'
			},
			{
				type: 'tutorial',
				text: 'Du kannst schleichenum unbemerkt zu bleiben.'
			},
			{
				type: 'tutorial',
				text: 'Halte [Shift]um zu sprinten ‚Äì aber sei sparsam mit deiner Ausdauer.'
			},
			{
				type: 'tutorial',
				text: 'Schwache Gegner erkennst du an ihrer Haltung.'
			},
			{
				type: 'tutorial',
				text: 'In dunklen Gebieten hilft dir eine Fackel.'
			},
			{
				type: 'tutorial',
				text: 'Kartenfragmente helfen dir beim Erkunden.'
			}
		],
		quest_event: [
			{
				type: 'quest_event',
				text: 'Du hast einen neuen Auftrag erhalten.'
			},
			{
				type: 'quest_event',
				text: 'Die Aufgabe ist abgeschlossen ‚Äì kehre zum Auftraggeber zur√ºck.'
			},
			{
				type: 'quest_event',
				text: 'Ein Tagebucheintrag wurde aktualisiert.'
			},
			{
				type: 'quest_event',
				text: 'Dein Fortschritt wurde gespeichert.'
			},
			{
				type: 'quest_event',
				text: 'Du findest einen Hinweis auf das n√§chste Ziel.'
			},
			{
				type: 'quest_event',
				text: 'Etwas stimmt nicht... die Quest entwickelt sich anders.'
			},
			{
				type: 'quest_event',
				text: 'Ein neuer Ort wurde auf deiner Karte markiert.'
			},
			{
				type: 'quest_event',
				text: 'Ein alter Bekannter hat dir eine neue Mission gegeben.'
			},
			{
				type: 'quest_event',
				text: 'Du brauchst ein besonderes Item f√ºr diese Aufgabe.'
			},
			{
				type: 'quest_event',
				text: 'Die Belohnung f√ºr diese Aufgabe wartet auf dich.'
			}
		],
		ambient: [
			{
				type: 'ambient',
				text: 'Die B√§ume fl√ºstern im Wind ‚Äì etwas Altes lebt noch hier.'
			},
			{
				type: 'ambient',
				text: 'Ein ferner Donner hallt durch die Berge.'
			},
			{
				type: 'ambient',
				text: 'Im Dunst der Ebene liegt ein Geruch von Asche.'
			},
			{
				type: 'ambient',
				text: 'Ein Stern f√§llt langsam vom Himmel ‚Äì leuchtend wie ein Traum.'
			},
			{
				type: 'ambient',
				text: 'Das Wasser spiegelt eine andere Welt.'
			},
			{
				type: 'ambient',
				text: 'Ein leises Fl√ºstern begleitet dich durch die H√∂hle.'
			},
			{
				type: 'ambient',
				text: 'Der Wind tr√§gt vergessene Lieder zu dir.'
			},
			{
				type: 'ambient',
				text: 'Dein Schatten scheint sich anders zu bewegen...'
			},
			{
				type: 'ambient',
				text: 'Der Boden knirscht ‚Äì war da etwas unter der Erde?'
			},
			{
				type: 'ambient',
				text: 'Nebel zieht √ºber das Land ‚Äì die Sicht ist eingeschr√§nkt.'
			}
		]
	}

	const masterLootTable: LootItem[] = [
		{
			name: 'Rusty Sword',
			rarity: 'common',
			category: 'weapon',
			dropChance: 40
		},
		{
			name: 'Iron Axe',
			rarity: 'uncommon',
			category: 'weapon',
			dropChance: 30
		},
		{ name: 'Flame Bow', rarity: 'rare', category: 'weapon', dropChance: 20 },
		{
			name: 'Shadow Dagger',
			rarity: 'epic',
			category: 'weapon',
			dropChance: 7
		},
		{
			name: 'Blade of Eternity',
			rarity: 'legendary',
			category: 'weapon',
			dropChance: 3
		},

		{
			name: 'Leather Armor',
			rarity: 'common',
			category: 'armor',
			dropChance: 50
		},
		{
			name: 'Iron Plate',
			rarity: 'uncommon',
			category: 'armor',
			dropChance: 25
		},
		{ name: 'Magic Robe', rarity: 'rare', category: 'armor', dropChance: 15 },
		{
			name: 'Dragon Scale Armor',
			rarity: 'epic',
			category: 'armor',
			dropChance: 7
		},
		{
			name: 'Aegis of the Ancients',
			rarity: 'legendary',
			category: 'armor',
			dropChance: 3
		},

		{
			name: 'Health Potion',
			rarity: 'common',
			category: 'potion',
			dropChance: 60
		},
		{
			name: 'Mana Potion',
			rarity: 'common',
			category: 'potion',
			dropChance: 20
		},
		{
			name: 'Stamina Elixir',
			rarity: 'uncommon',
			category: 'potion',
			dropChance: 10
		},
		{
			name: 'Potion of Invincibility',
			rarity: 'epic',
			category: 'potion',
			dropChance: 5
		},
		{
			name: 'Elixir of Time',
			rarity: 'legendary',
			category: 'potion',
			dropChance: 5
		},

		{
			name: 'Iron Ore',
			rarity: 'common',
			category: 'material',
			dropChance: 40
		},
		{
			name: 'Enchanted Wood',
			rarity: 'uncommon',
			category: 'material',
			dropChance: 30
		},
		{
			name: 'Soul Shard',
			rarity: 'rare',
			category: 'material',
			dropChance: 20
		},
		{
			name: 'Mystic Crystal',
			rarity: 'epic',
			category: 'material',
			dropChance: 7
		},
		{
			name: 'Void Essence',
			rarity: 'legendary',
			category: 'material',
			dropChance: 3
		},

		{
			name: 'Mystery Key',
			rarity: 'uncommon',
			category: 'special',
			dropChance: 50
		},
		{
			name: 'Treasure Map',
			rarity: 'rare',
			category: 'special',
			dropChance: 25
		},
		{
			name: 'Teleport Scroll',
			rarity: 'rare',
			category: 'special',
			dropChance: 15
		},
		{ name: 'Pet Egg', rarity: 'epic', category: 'special', dropChance: 7 },
		{
			name: 'Ancient Relic',
			rarity: 'legendary',
			category: 'special',
			dropChance: 3
		}
	]

	const rarityColors: Record<Rarity, string> = {
		common: '#aaa',
		uncommon: '#4caf50',
		rare: '#2196f3',
		epic: '#9c27b0',
		legendary: '#ffc107'
	}

	function getLoot(table: LootItem[]): LootItem | null {
		const roll = Math.random() * 100
		let accumulated = 0

		for (const item of table) {
			accumulated += item.dropChance
			if (roll <= accumulated) {
				return item
			}
		}

		return null
	}

	function generateRandomLoot(): LootItem | null {
		const categories: Category[] = [
			'weapon',
			'armor',
			'potion',
			'material',
			'special'
		]
		const randomCategory =
			categories[Math.floor(Math.random() * categories.length)]
		const filteredTable = masterLootTable.filter(
			(item) => item.category === randomCategory
		)
		return getLoot(filteredTable)
	}

	let lastDrop: LootItem | null = $state([])
	let history: LootItem[] = $state([])

	function openLootBox() {
		const drop = generateRandomLoot()
		lastDrop = drop
		if (drop) history.unshift(drop)
	}
</script>

<section class="page-layer nwp center">
	<div class="bg-base-200 flex flex-col gap-4">
		<h2 class="rgb-title text-5xl font-bold">Loot Generator</h2>

		<nav class="flex justify-center gap-2 py-4">
			<button class="btn btn-info btn-lg btn-wide" on:click={openLootBox}
				>Loot √∂ffnen</button>
		</nav>

		{#if lastDrop}
			<div class="item" style="color: {rarityColors[lastDrop.rarity]}">
				Du hast <span class="rarity">{lastDrop.name}</span> gefunden!
				<br />
				<small>({lastDrop.rarity}, {lastDrop.category})</small>
			</div>
		{/if}

		{#if history.length > 0}
			<div class="log">
				<h4>üìú Letzte Drops:</h4>
				<ul>
					{#each history.slice(0, 5) as item}
						<li style="color: {rarityColors[item.rarity]}">
							{item.name} ({item.rarity}, {item.category})
						</li>
					{/each}
				</ul>
			</div>
		{/if}
	</div>
</section>
